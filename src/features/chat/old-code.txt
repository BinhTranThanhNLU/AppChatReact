




        // 10. CHECK_USER_EXIST (Káº¿t quáº£ tÃ¬m kiáº¿m user) + invvite user vÃ o room
    if (res.event === "CHECK_USER_EXIST") {
      console.log("CHECK_USER_EXIST Response:", res);

      if (res.status === "success" && res.data?.status === true) {
        // KIá»‚M TRA XEM CÃ“ ÄANG Má»œI VÃ€O ROOM KHÃ”NG
        const pendingInviteStr = sessionStorage.getItem("pendingInvite");

        if (pendingInviteStr) {
          try {
            const pendingInvite = JSON.parse(pendingInviteStr);
            const { username, roomName } = pendingInvite;

            console.log(`Äang gá»­i lá»i má»i ${username} vÃ o room ${roomName}`);

            // Gá»­i tin nháº¯n má»i vÃ o room
            sendSocket({
              action: "onchat",
              data: {
                event: "SEND_CHAT",
                data: {
                  type: "room",
                  to: roomName,
                  mes: `ğŸ”” @${username} Ä‘Ã£ Ä‘Æ°á»£c má»i vÃ o nhÃ³m! `,
                },
              },
            });

            alert(`ÄÃ£ gá»­i lá»i má»i Ä‘áº¿n ${username}!`);
            sessionStorage.removeItem("pendingInvite");
            return; //QUAN TRá»ŒNG: Dá»«ng táº¡i Ä‘Ã¢y, khÃ´ng cháº¡y logic tÃ¬m user bÃªn dÆ°á»›i
          } catch (error) {
            console.error("Lá»—i parse pendingInvite:", error);
          }
        }

        //TRÆ¯á»œNG Há»¢P TÃŒM USER Äá»‚ CHAT (khÃ´ng pháº£i má»i vÃ o room)
        const userName = pendingUserSearch;

        if (!userName || typeof userName !== "string") {
          console.error("User name khÃ´ng há»£p lá»‡:", userName);
          return;
        }

        const userFound = { name: userName };

        const users = store.getState().chat.users;
        const exists = users.find((u) => u.name === userFound.name);

        if (!exists) {
          store.dispatch(addUser(userFound));
          console.log("ÄÃ£ thÃªm user tÃ¬m tháº¥y vÃ o danh sÃ¡ch:", userFound.name);
        } else {
          console.log("User Ä‘Ã£ cÃ³ trong danh sÃ¡ch:", userFound.name);
        }

        pendingUserSearch = null;
      } else {
        alert("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i!");
        pendingUserSearch = null;
        sessionStorage.removeItem("pendingInvite"); //XÃ“A PENDING INVITE Náº¾U USER KHÃ”NG Tá»’N Táº I
      }
      return;
    }